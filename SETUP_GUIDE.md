# App Store Connect セットアップガイド

## StoreKit 2 サブスクリプション製品の設定手順

### 前提条件
- Apple Developer Program に登録済み（年額 $99）
- App Store Connect にアクセス可能
- アプリが App Store Connect に登録済み（または新規作成予定）

---

## ステップ1: App Store Connect にログイン

1. [App Store Connect](https://appstoreconnect.apple.com/) にアクセス
2. Apple ID でログイン

---

## ステップ2: アプリを選択または作成

1. **「マイApp」** をクリック
2. 既存のアプリを選択するか、**「+」** をクリックして新規アプリを作成
   - アプリ名: TrapFinder（または任意の名前）
   - プライマリ言語: 日本語
   - バンドルID: あなたのバンドルID（例: `com.yourcompany.trapfinder`）

---

## ステップ3: サブスクリプショングループを作成

1. アプリの詳細ページで、左メニューから **「機能」** → **「App内課金」** を選択
2. **「サブスクリプション」** タブをクリック
3. **「+」** をクリックして **「サブスクリプショングループを作成」** を選択
4. グループ名を入力（例: `TrapFinder Subscriptions`）
5. **「作成」** をクリック

---

## ステップ4: サブスクリプション製品を作成

1. 作成したサブスクリプショングループ内で **「+」** をクリック
2. **「サブスクリプションを作成」** を選択

### 必須項目を入力：

#### 基本情報
- **製品ID**: `standard_monthly` ⚠️ **重要**: コード内の `PlanConfiguration.swift` と完全に一致させる
- **参照名**: `Standard Plan`（管理用の名前、ユーザーには表示されない）

#### 期間と価格
- **期間**: `1ヶ月`
- **価格**: `¥480`（または希望する価格）

#### 表示名と説明（日本語）
- **表示名**: `スタンダードプラン`
- **説明**: 
  ```
  • スキャン回数: 無制限
  • 文字数制限: 50,000文字/回
  • AIモデル: GPT-4o-mini
  ```

#### 表示名と説明（英語、オプション）
- **表示名**: `Standard Plan`
- **説明**:
  ```
  • Unlimited scans per day
  • Character limit: 50,000 per scan
  • AI Model: GPT-4o-mini
  ```

3. **「作成」** をクリック

---

## ステップ5: 製品の状態を確認

1. 作成した製品が **「準備完了」** の状態になっていることを確認
2. 製品IDが `standard_monthly` と一致していることを再確認

---

## ステップ6: サンドボックステストアカウントの作成（テスト用）

1. App Store Connect の左メニューから **「ユーザーとアクセス」** → **「サンドボックステスター」** を選択
2. **「+」** をクリック
3. テスト用のメールアドレスを入力（実在するメールアドレスが必要）
4. **「招待」** をクリック
5. メールに送られてきたリンクからアカウントを有効化

---

## ステップ7: Xcode でのテスト設定

### 実機でのテスト

1. **設定** → **App Store** → **サンドボックスアカウント** に移動
2. ステップ6で作成したサンドボックステスターアカウントでログイン
3. Xcode でアプリを実機にインストール
4. アプリ内で購入をテスト

### シミュレーターでのテスト

- シミュレーターでは実際の購入はできませんが、製品情報の取得は可能です
- 実機でのテストを推奨します

---

## ステップ8: コード内の製品IDを確認

`App/App/Config/PlanConfiguration.swift` を開いて、製品IDが一致しているか確認：

```swift
static let standardPlanID = "standard_monthly"  // ← App Store Connect と一致しているか確認
```

---

## よくある問題と解決方法

### ❌ 「プランが見つかりません」エラー

**原因:**
- App Store Connect で製品が作成されていない
- 製品IDが一致していない
- 製品の状態が「準備完了」になっていない

**解決方法:**
1. App Store Connect で製品ID `standard_monthly` が存在するか確認
2. `PlanConfiguration.swift` の製品IDと一致しているか確認
3. 製品の状態が「準備完了」になっているか確認

### ❌ 「製品情報の取得に失敗しました」エラー

**原因:**
- インターネット接続の問題
- App Store Connect の設定が完了していない

**解決方法:**
1. インターネット接続を確認
2. App Store Connect で製品が正しく設定されているか確認
3. 数分待ってから再度試す（反映に時間がかかる場合がある）

### ❌ サンドボックステストで購入できない

**原因:**
- サンドボックステスターアカウントでログインしていない
- アカウントが有効化されていない

**解決方法:**
1. 設定 → App Store → サンドボックスアカウントでログインしているか確認
2. メールのリンクからアカウントを有効化したか確認

---

## チェックリスト

- [ ] App Store Connect にログインできた
- [ ] アプリが作成された（または既存のアプリを選択）
- [ ] サブスクリプショングループが作成された
- [ ] 製品ID `standard_monthly` で製品が作成された
- [ ] 製品の状態が「準備完了」になっている
- [ ] サンドボックステスターアカウントが作成された
- [ ] 実機でサンドボックスアカウントにログインした
- [ ] `PlanConfiguration.swift` の製品IDが一致している
- [ ] アプリで製品が読み込まれることを確認した

---

## 参考リンク

- [App Store Connect ヘルプ](https://help.apple.com/app-store-connect/)
- [StoreKit 2 ドキュメント](https://developer.apple.com/documentation/storekit)
- [サブスクリプションの設定ガイド](https://developer.apple.com/app-store/subscriptions/)

---

## 次のステップ

製品の設定が完了したら：
1. アプリをビルドして実機にインストール
2. サンドボックステスターアカウントで購入をテスト
3. 購入復元機能もテスト
4. 問題がなければ、App Store に提出準備
